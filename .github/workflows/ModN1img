name: Build Custom OpenWrt

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # 允许手动触发
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk gzip mount wget tar

      - name: Download and Modify OpenWrt image
        run: |
          echo "开始处理镜像文件..."
          
          # 下载镜像文件
          wget https://github.com/ju-svg/amlogic-s9xxx-openwrt/releases/download/OpenWrt_imagebuilder_openwrt_23.05.5_12.26.1248/openwrt_amlogic_s905d_k6.1.121_2024.12.26.img.gz
          
          # 创建工作目录
          WORK_DIR="openwrt_mod"
          mkdir -p "$WORK_DIR"
          cd "$WORK_DIR"
          
          # 解压 .gz 镜像
          echo "解压镜像文件..."
          gzip -d ../openwrt_amlogic_s905d_k6.1.121_2024.12.26.img.gz
          
          # 创建挂载点
          mkdir -p mount_point
          
          # 获取分区信息
          echo "获取分区信息..."
          fdisk -l ../openwrt_amlogic_s905d_k6.1.121_2024.12.26.img
          
          # 使用 losetup 设置循环设备
          LOOP_DEV=$(sudo losetup -f)
          sudo losetup "$LOOP_DEV" ../openwrt_amlogic_s905d_k6.1.121_2024.12.26.img
          
          # 扫描分区表
          sudo partprobe "$LOOP_DEV"
          
          # 获取第二个分区（通常是根文件系统）
          PART_DEV="${LOOP_DEV}p2"
          
          # 挂载分区
          echo "挂载分区..."
          sudo mount "$PART_DEV" mount_point
          
          # 解压自定义文件
          echo "添加自定义文件..."
          sudo tar -xzf ../custom-files.tar.gz -C mount_point/
          
          # 设置权限
          echo "设置文件权限..."
          if [ -f "mount_point/usr/bin/clash" ]; then
            sudo chmod 755 mount_point/usr/bin/clash
          fi
          
          if [ -d "mount_point/etc/clash" ]; then
            sudo chmod -R 755 mount_point/etc/clash
            sudo find mount_point/etc/clash -type f -exec chmod 644 {} \;
          fi
          
          # 同步文件系统
          echo "同步文件系统..."
          sync
          
          # 卸载分区
          echo "清理挂载..."
          sudo umount mount_point
          sudo losetup -d "$LOOP_DEV"
          
          # 重新压缩镜像
          echo "重新压缩镜像..."
          cd ..
          gzip -f openwrt_amlogic_s905d_k6.1.121_2024.12.26.img
          
          # 清理临时文件
          rm -rf "$WORK_DIR"
          
          echo "镜像修改完成！"

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ github.run_number }}
          name: Release ${{ github.run_number }}
          files: openwrt_amlogic_s905d_k6.1.121_2024.12.26.img.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

